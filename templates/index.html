<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§öÂä®‰ΩúËÆ°Êï∞Âô® - ÁΩëÈ°µÁïåÈù¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        
        .main-content {
            display: flex;
            min-height: 700px;
            max-height: 100vh;
        }
        
        .video-section {
            flex: 3;
            padding: 20px;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            max-height: 100vh;
        }
        
        .video-area {
            flex-shrink: 0;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .video-controls-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }
        
        .controls-section {
            flex: 2;
            padding: 20px;
            background-color: #fafafa;
            overflow-y: auto;
            max-height: 100vh;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            height: 380px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #videoFeed {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .video-placeholder {
            width: 100%;
            height: 100%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 1.2em;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s ease;
        }
        
        .count-display {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .count-display h2 {
            margin: 0;
            font-size: 2em;
        }
        
        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 3px;
            font-size: 1em;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        
        select, input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .btn-save {
            background: linear-gradient(135deg, #51cf66, #40c057);
        }
        
        .parameter-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parameter-input input[type="range"] {
            flex: 1;
            height: 6px;
        }
        
        .parameter-input .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 0.85em;
        }
        
        .center-line-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin: 8px 0;
        }
        
        .btn-adjust, .btn-reset {
            flex: 1;
            min-width: 70px;
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-adjust {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-adjust:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }
        
        .btn-reset:hover {
            background: linear-gradient(135deg, #F57C00, #E65100);
            transform: translateY(-1px);
        }
        
        .counter-category {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .counter-category h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .counter-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .video-hidden {
            opacity: 0 !important;
            pointer-events: none;
        }
        
        .video-visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Center line controls styling */
        #centerLineGroup {
            background: #f0f8ff;
            border: 2px solid #4CAF50;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
        }
        
        #centerLineGroup h3 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 0.95em;
        }
        
        .keyboard-controls-info {
            background: #fff9c4;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #FFC107;
            font-family: monospace;
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        kbd {
            background: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .video-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèãÔ∏è Â§öÂä®‰ΩúËÆ°Êï∞Âô®</h1>
            <p>ÂÆûÊó∂ËøêÂä®ËÆ°Êï∞‰∏éAIÂßøÂäøÊ£ÄÊµã</p>
        </div>
        
        <div class="main-content">
            <div class="video-section">
                <!-- Fixed Video Area -->
                <div class="video-area">
                    <div class="video-container">
                        <img id="videoFeed" src="" alt="ËßÜÈ¢ëÊµÅÂ∞ÜÂú®Ê≠§ÊòæÁ§∫" class="video-hidden">
                        <div id="videoPlaceholder" class="video-placeholder video-visible">
                            ÈÄâÊã©ËÆ°Êï∞Âô®Âπ∂ÁÇπÂáªÂºÄÂßã
                        </div>
                    </div>
                    
                    <div class="count-display">
                        <h2 id="currentCount">ËÆ°Êï∞: 0</h2>
                        <p id="counterName">Êú™ÈÄâÊã©ËÆ°Êï∞Âô®</p>
                    </div>
                </div>
                
                <!-- Scrollable Controls Area -->
                <div class="video-controls-area">
                    <!-- Parameters Section -->
                    <div class="control-group" id="parametersGroup">
                        <h3>‚öôÔ∏è ÂèÇÊï∞ËÆæÁΩÆ</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                            Ê†πÊçÆÊâÄÈÄâËÆ°Êï∞Âô®Á±ªÂûãË∞ÉÊï¥Ê£ÄÊµãÂèÇÊï∞ÔºåÊèêÈ´òËÆ°Êï∞ÂáÜÁ°ÆÊÄßÔºö
                        </p>
                        <div id="parameterControls"></div>
                        <div style="font-size: 0.8em; color: #555; margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                            <strong>üìñ ÂèÇÊï∞ËØ¥Êòé (Parameter Descriptions)Ôºö</strong><br>
                            ‚Ä¢ <strong>Threshold (Ê£ÄÊµãÈòàÂÄº)</strong>: ÊúÄÈáçË¶ÅÂèÇÊï∞ÔºåÊéßÂà∂Ê£ÄÊµãÊïèÊÑüÂ∫¶ÔºåÂÄºË∂äÂ∞èË∂äÊïèÊÑü<br>
                            ‚Ä¢ <strong>Confidence Threshold (ÁΩÆ‰ø°Â∫¶ÈòàÂÄº)</strong>: YOLOÁõÆÊ†áÊ£ÄÊµãÁöÑÊúÄÂ∞èÁΩÆ‰ø°Â∫¶Ë¶ÅÊ±Ç<br>
                            ‚Ä¢ <strong>Validation Threshold (È™åËØÅÈòàÂÄº)</strong>: Âä®‰ΩúÈ™åËØÅÁöÑ‰∏•Ê†ºÁ®ãÂ∫¶<br>
                            ‚Ä¢ <strong>Stable Frames (Á®≥ÂÆöÂ∏ßÊï∞)</strong>: ÈúÄË¶ÅËøûÁª≠Ê£ÄÊµãÂ§öÂ∞ëÂ∏ßÊâçÁ°ÆËÆ§Âä®‰Ωú<br>
                            ‚Ä¢ <strong>Calibration Frames (Ê†°ÂáÜÂ∏ßÊï∞)</strong>: Ëá™Âä®Ê†°ÂáÜÈúÄË¶ÅÁöÑÂ∏ßÊï∞<br>
                            ‚Ä¢ <strong>Min Visibility (ÊúÄÂ∞èÂèØËßÅÂ∫¶)</strong>: ‰∫∫‰ΩìÂÖ≥ÈîÆÁÇπÂèØËßÅÂ∫¶Ë¶ÅÊ±Ç<br>
                            ‚Ä¢ <strong>Anti-Cheat (Èò≤‰ΩúÂºäÊ£ÄÊµã)</strong>: ÂêØÁî®Âä®‰ΩúÈ™åËØÅÊú∫Âà∂
                            </div>
                        </div>
                        
                    <!-- Center Line Controls -->
                    <div class="control-group hidden" id="centerLineGroup">
                        <h3>üéØ ‰∏≠ÂøÉÁ∫øÊéßÂà∂ (YOLOËÆ°Êï∞Âô®)</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                            Ë∞ÉÊï¥YOLOËÆ°Êï∞Âô®ÁöÑÊ£ÄÊµãÂèÇËÄÉÁ∫ø‰ΩçÁΩÆÔºåÁî®‰∫éÂä®Áâ©Ë∑≥Ë∑ÉÂíåÁâ©‰ΩìÂºπË∑≥Ê£ÄÊµãÔºö
                        </p>
                        
                        <div class="form-group">
                            <label for="centerLineSlider">
                                Center Line Position (‰∏≠ÂøÉÁ∫ø‰ΩçÁΩÆ) - Pixels:
                                <span style="font-size: 0.8em; color: #888;">Ë∞ÉÊï¥Ê£ÄÊµãÁöÑÁõÆÊ†á‰ΩçÁΩÆ</span>
                            </label>
                            <div class="parameter-input">
                                <input type="range" id="centerLineSlider" min="50" max="2000" step="10" value="1000">
                                <span class="range-value" id="centerLineSliderValue">1000</span>
                            </div>
                            <div style="font-size: 0.8em; color: #555; margin-top: 5px;">
                                ‚Ä¢ Animal Counters (Âä®Áâ©ËÆ°Êï∞Âô®)ÔºöËÆæÁΩÆË∑≥Ë∑ÉÁõÆÊ†áÁ∫øÈ´òÂ∫¶<br>
                                ‚Ä¢ Object Counters (Áâ©‰ΩìËÆ°Êï∞Âô®)ÔºöËÆæÁΩÆÂú∞Èù¢ÂèÇËÄÉÁ∫ø‰ΩçÁΩÆ
                        </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="sensitivitySlider">
                                Sensitivity Multiplier (Ê£ÄÊµãÁÅµÊïèÂ∫¶) - Factor:
                                <span style="font-size: 0.8em; color: #888;">Ë∞ÉÊï¥Ê£ÄÊµãÂå∫ÂüüÂ§ßÂ∞è</span>
                            </label>
                            <div class="parameter-input">
                                <input type="range" id="sensitivitySlider" min="0.3" max="3.0" step="0.1" value="1.0">
                                <span class="range-value" id="sensitivitySliderValue">1.0</span>
                            </div>
                            <div style="font-size: 0.8em; color: #555; margin-top: 5px;">
                                ‚Ä¢ Lower Value (ÂÄºË∂äÂ∞è)ÔºöÊ£ÄÊµãË∂äÊïèÊÑüÔºåÊõ¥ÂÆπÊòìËß¶ÂèëËÆ°Êï∞<br>
                                ‚Ä¢ Higher Value (ÂÄºË∂äÂ§ß)ÔºöÊ£ÄÊµãË∂äÂÆΩÊùæÔºåÈúÄË¶ÅÊõ¥ÊòéÊòæÁöÑÂä®‰Ωú
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Quick Adjustment Buttons (Âø´ÈÄüË∞ÉÊï¥ÊåâÈíÆ):</label>
                            <div class="center-line-controls">
                                <button type="button" onclick="adjustCenterLine(-0.05)" class="btn-adjust" title="Âêë‰∏äÁßªÂä®‰∏≠ÂøÉÁ∫ø10ÂÉèÁ¥†">‚¨ÜÔ∏è Up (Âêë‰∏ä)</button>
                                <button type="button" onclick="adjustCenterLine(0.05)" class="btn-adjust" title="Âêë‰∏ãÁßªÂä®‰∏≠ÂøÉÁ∫ø10ÂÉèÁ¥†">‚¨áÔ∏è Down (Âêë‰∏ã)</button>
                                <button type="button" onclick="resetCalibration()" class="btn-reset" title="ÈáçÊñ∞Ëá™Âä®Ê†°ÂáÜÊ£ÄÊµãÁ∫ø">üîÑ Reset (ÈáçÁΩÆÊ†°ÂáÜ)</button>
                            </div>
                            <div style="font-size: 0.8em; color: #555; margin-top: 5px;">
                                ÊØèÊ¨°ÁÇπÂáªË∞ÉÊï¥Á∫¶10ÂÉèÁ¥†ÔºåÁî®‰∫éÁ≤æÁªÜË∞ÉËäÇÊ£ÄÊµã‰ΩçÁΩÆ
                        </div>
                    </div>
                    
                        <div class="keyboard-controls-info">
                            <p><strong>üéÆ ÈîÆÁõòÂø´Êç∑ÈîÆÊéßÂà∂:</strong></p>
                            <p><kbd>W</kbd>/<kbd>‚Üë</kbd>: ‰∏≠ÂøÉÁ∫ø‰∏äÁßª | <kbd>S</kbd>/<kbd>‚Üì</kbd>: ‰∏≠ÂøÉÁ∫ø‰∏ãÁßª</p>
                            <p><kbd>+</kbd>: Èôç‰ΩéÁÅµÊïèÂ∫¶ (Â¢ûÂ§ßÊ£ÄÊµãÂå∫Âüü) | <kbd>-</kbd>: ÊèêÈ´òÁÅµÊïèÂ∫¶ (Áº©Â∞èÊ£ÄÊµãÂå∫Âüü)</p>
                            <p><kbd>0</kbd>: ÈáçÁΩÆÊ†°ÂáÜ (ÊÅ¢Â§çËá™Âä®Ê£ÄÊµã)</p>
                            <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                üí° ÊèêÁ§∫ÔºöÂêØÂä®ËÆ°Êï∞Âô®ÂêéÔºåÁ≥ªÁªü‰ºöËá™Âä®Ê†°ÂáÜ„ÄÇÂ¶ÇÊûúÊ£ÄÊµã‰∏çÂáÜÁ°ÆÔºåÂèØ‰ΩøÁî®‰∏äËø∞ÊéßÂà∂ËøõË°åÊâãÂä®Ë∞ÉÊï¥„ÄÇ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="controls-section">
                <div id="statusMessage" class="status-message hidden"></div>
                
                <div class="control-group">
                    <h3>üéØ ËÆ°Êï∞Âô®ÈÄâÊã©</h3>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        ÈÄâÊã©ÈÄÇÂêàÊÇ®ÈúÄÊ±ÇÁöÑAIËÆ°Êï∞Âô®Á±ªÂûãÔºö
                    </div>
                    
                    <!-- Human Action Counters -->
                    <div class="counter-category">
                        <h4>üèÉ‚Äç‚ôÄÔ∏è ‰∫∫‰ΩìÂä®‰ΩúËÆ°Êï∞Âô® (MediaPipe AI)</h4>
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">
                            Âü∫‰∫é‰∫∫‰ΩìÂßøÊÄÅËØÜÂà´ÁöÑËøêÂä®ËÆ°Êï∞ÔºåÈÄÇÁî®‰∫éÂÅ•Ë∫´ËÆ≠ÁªÉÂíåËøêÂä®ÂàÜÊûê
                        </div>
                        <div class="form-group">
                            <select id="humanCounterSelect" class="counter-select">
                                <option value="">ÈÄâÊã©‰∫∫‰ΩìÂä®‰ΩúËÆ°Êï∞Âô®...</option>
                                {% for counter in counters.Human %}
                                <option value="{{ counter.name }}" data-type="{{ counter.type }}" data-category="human">
                                    {{ counter.name }} - {{ counter.logic_type }}Âä®‰ΩúÊ£ÄÊµã
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Animal Counters -->
                    <div class="counter-category">
                        <h4>üêæ Âä®Áâ©ËÆ°Êï∞Âô® (YOLO AI)</h4>
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">
                            Âü∫‰∫éÁõÆÊ†áÊ£ÄÊµãÁöÑÂä®Áâ©Ë°å‰∏∫ËÆ°Êï∞ÔºåÈÄÇÁî®‰∫éÂÆ†Áâ©ËøêÂä®ÁõëÊµãÂíåÁ†îÁ©∂
                        </div>
                        <div class="form-group">
                            <select id="animalCounterSelect" class="counter-select">
                                <option value="">ÈÄâÊã©Âä®Áâ©ËÆ°Êï∞Âô®...</option>
                                {% for counter in counters.Animal %}
                                <option value="{{ counter.name }}" data-type="{{ counter.type }}" data-category="animal">
                                    {{ counter.name }} - {{ counter.object_class }}{{ counter.logic_type }}Ê£ÄÊµã
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Object Counters -->
                    <div class="counter-category">
                        <h4>üèÄ Áâ©‰ΩìËÆ°Êï∞Âô® (YOLO AI)</h4>
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">
                            Âü∫‰∫éÁõÆÊ†áÊ£ÄÊµãÁöÑÁâ©‰ΩìËøêÂä®ËÆ°Êï∞ÔºåÈÄÇÁî®‰∫éÁêÉÁ±ªËøêÂä®ÂíåÁâ©‰ΩìËøΩË∏™
                        </div>
                        <div class="form-group">
                            <select id="objectCounterSelect" class="counter-select">
                                <option value="">ÈÄâÊã©Áâ©‰ΩìËÆ°Êï∞Âô®...</option>
                                {% for counter in counters.Object %}
                                <option value="{{ counter.name }}" data-type="{{ counter.type }}" data-category="object">
                                    {{ counter.name }} - {{ counter.object_class }}{{ counter.logic_type }}Ê£ÄÊµã
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="videoSource">ËßÜÈ¢ëÊ∫êÈÄâÊã©:</label>
                        <select id="videoSource">
                            <option value="0">ÊëÑÂÉèÂ§¥ (ÊëÑÂÉèÂ§¥ 0) - ÂÆûÊó∂Ê£ÄÊµã</option>
                            <option value="1">ÊëÑÂÉèÂ§¥ (ÊëÑÂÉèÂ§¥ 1) - Â§áÁî®ÊëÑÂÉèÂ§¥</option>
                            <option value="upload">‰∏ä‰º†ËßÜÈ¢ëÊñá‰ª∂ - ÂàÜÊûêÂΩïÂà∂ËßÜÈ¢ë</option>
                            <option value="uploaded">‰ΩøÁî®Â∑≤‰∏ä‰º†ËßÜÈ¢ë - ÈÄâÊã©ÂéÜÂè≤ËßÜÈ¢ë</option>
                        </select>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            üí° ÊèêÁ§∫ÔºöÊëÑÂÉèÂ§¥Áî®‰∫éÂÆûÊó∂Ê£ÄÊµãÔºå‰∏ä‰º†ËßÜÈ¢ëÁî®‰∫éÂàÜÊûêÂ∑≤ÂΩïÂà∂ÁöÑËøêÂä®ËßÜÈ¢ë
                        </div>
                    </div>
                    
                    <div class="form-group hidden" id="uploadVideoGroup">
                        <label>‰∏ä‰º†Êñ∞ËßÜÈ¢ëÊñá‰ª∂:</label>
                        <input type="file" id="videoFileInput" accept=".mp4,.avi,.mov,.mkv,.wmv,.flv,.webm,.m4v">
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            ÊîØÊåÅÊ†ºÂºèÔºöMP4, AVI, MOV, MKV, WMV, FLV, WebM, M4V<br>
                            Êé®Ëçê‰ΩøÁî®MP4Ê†ºÂºèÔºåÊñá‰ª∂Â§ßÂ∞èÈôêÂà∂100MB
                        </div>
                    </div>
                    
                    <div class="form-group hidden" id="uploadedVideoGroup">
                        <label for="uploadedVideoSelect">ÈÄâÊã©Â∑≤‰∏ä‰º†ÁöÑËßÜÈ¢ë:</label>
                        <select id="uploadedVideoSelect">
                            <option value="">Âä†ËΩΩ‰∏≠...</option>
                        </select>
                        <button type="button" onclick="loadUploadedVideos()" style="margin-top: 5px; padding: 5px 10px; font-size: 12px;">üîÑ Âà∑Êñ∞ËßÜÈ¢ëÂàóË°®</button>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            ÈÄâÊã©‰πãÂâç‰∏ä‰º†ÁöÑËßÜÈ¢ëÊñá‰ª∂ËøõË°åÈáçÊñ∞ÂàÜÊûê
                    </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>üéÆ ËÆ°Êï∞ÊéßÂà∂</h3>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        ÊéßÂà∂ËÆ°Êï∞Âô®ÁöÑÂêØÂä®„ÄÅÂÅúÊ≠¢ÂíåÊï∞ÊçÆ‰øùÂ≠òÔºö
                    </div>
                    <button id="startBtn" onclick="startCounter()" title="ÂºÄÂßãËßÜÈ¢ëÂ§ÑÁêÜÂíåÂä®‰ΩúËÆ°Êï∞">üöÄ ÂºÄÂßãËÆ°Êï∞</button>
                    <button id="stopBtn" onclick="stopCounter()" class="btn-stop" disabled title="ÂÅúÊ≠¢ÂΩìÂâçÁöÑËÆ°Êï∞‰ºöËØù">‚èπÔ∏è ÂÅúÊ≠¢ËÆ°Êï∞</button>
                    <button id="saveBtn" onclick="saveSession()" class="btn-save" disabled title="‰øùÂ≠òÂΩìÂâçËÆ°Êï∞‰ºöËØùÊï∞ÊçÆÂà∞Êñá‰ª∂">üíæ ‰øùÂ≠ò‰ºöËØùÊï∞ÊçÆ</button>
                    <div style="font-size: 0.8em; color: #555; margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                        <strong>üìã ‰ΩøÁî®ËØ¥ÊòéÔºö</strong><br>
                        1. ÈÄâÊã©ËÆ°Êï∞Âô®Á±ªÂûãÂíåËßÜÈ¢ëÊ∫ê<br>
                        2. Ë∞ÉÊï¥ÂèÇÊï∞ËÆæÁΩÆÔºàÂèØÈÄâÔºâ<br>
                        3. ÁÇπÂáª"ÂºÄÂßãËÆ°Êï∞"ÂêØÂä®Ê£ÄÊµã<br>
                        4. Á≥ªÁªüËá™Âä®Ê†°ÂáÜÂêéÂºÄÂßãËÆ°Êï∞<br>
                        5. ÂèØÈöèÊó∂‰øùÂ≠ò‰ºöËØùÊï∞ÊçÆ
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>üìπ ËßÜÈ¢ëÂΩïÂà∂</h3>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        ÂΩïÂà∂Â∏¶ÊúâËÆ°Êï∞‰ø°ÊÅØÁöÑÂ§ÑÁêÜÂêéËßÜÈ¢ëÔºö
                    </div>
                    <button id="startRecordingBtn" onclick="startRecording()" disabled title="ÂºÄÂßãÂΩïÂà∂ÂΩìÂâçÁöÑËßÜÈ¢ëÂ§ÑÁêÜÁîªÈù¢">üî¥ ÂºÄÂßãÂΩïÂà∂</button>
                    <button id="stopRecordingBtn" onclick="stopRecording()" class="btn-stop" disabled title="ÂÅúÊ≠¢ÂΩïÂà∂Âπ∂‰øùÂ≠òËßÜÈ¢ëÊñá‰ª∂">‚èπÔ∏è ÂÅúÊ≠¢ÂΩïÂà∂</button>
                    <button id="downloadRecordingBtn" onclick="downloadRecording()" class="btn-save" disabled title="‰∏ãËΩΩÊúÄËøëÂΩïÂà∂ÁöÑËßÜÈ¢ëÊñá‰ª∂">üíæ ‰∏ãËΩΩÂΩïÂà∂ËßÜÈ¢ë</button>
                    <div id="recordingStatus" style="margin-top: 10px; padding: 8px; background: #f0f8ff; border-radius: 4px; font-size: 0.9em; text-align: center;">ÂáÜÂ§áÂΩïÂà∂</div>
                    <div style="font-size: 0.8em; color: #555; margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                        <strong>üé¨ ÂΩïÂà∂ËØ¥ÊòéÔºö</strong><br>
                        ‚Ä¢ ÂΩïÂà∂ÁöÑËßÜÈ¢ëÂåÖÂê´Ê£ÄÊµãÁ∫ø„ÄÅËÆ°Êï∞‰ø°ÊÅØÂíåÊ£ÄÊµãÊ°Ü<br>
                        ‚Ä¢ ËßÜÈ¢ëÊ†ºÂºèÔºöMP4ÔºåÂ∏ßÁéáÔºö25fps<br>
                        ‚Ä¢ ÂàÜËæ®ÁéáÔºö‰∏éÁΩëÈ°µÊòæÁ§∫‰∏ÄËá¥ÔºàÊúÄÂ§ß640pxÂÆΩÂ∫¶Ôºâ<br>
                        ‚Ä¢ ÂΩïÂà∂Êñá‰ª∂‰øùÂ≠òÂú®recordingsÊñá‰ª∂Â§π‰∏≠
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let isRunning = false;
        let updateInterval;
        let selectedCounter = '';
        let selectedCounterType = '';
        let sliderTimeout = null;
        let isRecording = false;
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateParameterControls();
            loadUploadedVideos();
        });
        
        function setupEventListeners() {
            // ËÆ°Êï∞Âô®ÈÄâÊã©‰∫ã‰ª∂
            document.getElementById('humanCounterSelect').addEventListener('change', handleCounterSelection);
            document.getElementById('animalCounterSelect').addEventListener('change', handleCounterSelection);
            document.getElementById('objectCounterSelect').addEventListener('change', handleCounterSelection);
            
            // ÈîÆÁõòÊéßÂà∂
            document.addEventListener('keydown', handleKeyboard);
            
            // ËßÜÈ¢ëÊ∫êÂàáÊç¢
            document.getElementById('videoSource').addEventListener('change', function() {
                const uploadGroup = document.getElementById('uploadVideoGroup');
                const uploadedGroup = document.getElementById('uploadedVideoGroup');
                
                // ÈöêËóèÊâÄÊúâÁªÑ
                uploadGroup.classList.add('hidden');
                uploadedGroup.classList.add('hidden');
                
                if (this.value === 'upload') {
                    uploadGroup.classList.remove('hidden');
                } else if (this.value === 'uploaded') {
                    uploadedGroup.classList.remove('hidden');
                    loadUploadedVideos();
                }
            });
            
            // Êñá‰ª∂‰∏ä‰º†
            document.getElementById('videoFileInput').addEventListener('change', uploadVideo);
            
            // ÊªëÂùó‰∫ã‰ª∂
            setupSliders();
        }

        function setupSliders() {
            const centerLineSlider = document.getElementById('centerLineSlider');
            const sensitivitySlider = document.getElementById('sensitivitySlider');
            
            if (centerLineSlider) {
                centerLineSlider.addEventListener('input', function() {
                    document.getElementById('centerLineSliderValue').textContent = this.value;
                    
                    if (sliderTimeout) clearTimeout(sliderTimeout);
                    sliderTimeout = setTimeout(() => {
                        if (isRunning && selectedCounterType === 'yolo') {
                            adjustCenterLineAbsolute(parseFloat(this.value));
                        }
                    }, 300);
                });
            }
            
            if (sensitivitySlider) {
                sensitivitySlider.addEventListener('input', function() {
                    document.getElementById('sensitivitySliderValue').textContent = this.value;
                    
                    if (sliderTimeout) clearTimeout(sliderTimeout);
                    sliderTimeout = setTimeout(() => {
                        if (isRunning && selectedCounterType === 'yolo') {
                            adjustSensitivityAbsolute(parseFloat(this.value));
                        }
                    }, 300);
                });
            }
        }
        
        function handleCounterSelection(event) {
            // Ê∏ÖÈô§ÂÖ∂‰ªñÈÄâÊã©
            const selects = ['humanCounterSelect', 'animalCounterSelect', 'objectCounterSelect'];
            selects.forEach(selectId => {
                if (selectId !== event.target.id) {
                    document.getElementById(selectId).value = '';
                }
            });
            
            const option = event.target.selectedOptions[0];
            if (option && option.value) {
                selectedCounter = option.value;
                selectedCounterType = option.dataset.type;
                
                // ÊòæÁ§∫/ÈöêËóè‰∏≠ÂøÉÁ∫øÊéßÂà∂
            const centerLineGroup = document.getElementById('centerLineGroup');
            if (selectedCounterType === 'yolo') {
                centerLineGroup.classList.remove('hidden');
            } else {
                centerLineGroup.classList.add('hidden');
            }
            
                // Âä†ËΩΩËÆ°Êï∞Âô®‰ø°ÊÅØ
                loadCounterInfo(selectedCounter);
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                document.getElementById('counterName').textContent = selectedCounter;
            } else {
                selectedCounter = '';
                selectedCounterType = '';
                document.getElementById('centerLineGroup').classList.add('hidden');
                document.getElementById('counterName').textContent = 'Êú™ÈÄâÊã©ËÆ°Êï∞Âô®';
            }
        }

        async function loadCounterInfo(counterName) {
            try {
                const response = await fetch(`/get_counter_info/${counterName}`);
                const info = await response.json();
                
                if (info.error) {
                    showMessage(info.error, 'error');
                    return;
                }

                updateParameterControls(info.parameters);
            } catch (error) {
                showMessage(`Âä†ËΩΩËÆ°Êï∞Âô®‰ø°ÊÅØÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        function updateParameterControls(parameters = {}) {
            const container = document.getElementById('parameterControls');
            container.innerHTML = '';

            // English(Chinese) parameter name mapping with priority order
            const parameterNames = {
                'threshold': 'Threshold (Ê£ÄÊµãÈòàÂÄº)',
                'confidence_threshold': 'Confidence Threshold (ÁΩÆ‰ø°Â∫¶ÈòàÂÄº)',
                'validation_threshold': 'Validation Threshold (È™åËØÅÈòàÂÄº)',
                'stable_frames': 'Stable Frames (Á®≥ÂÆöÂ∏ßÊï∞)',
                'calibration_frames': 'Calibration Frames (Ê†°ÂáÜÂ∏ßÊï∞)',
                'min_visibility': 'Min Visibility (ÊúÄÂ∞èÂèØËßÅÂ∫¶)',
                'enable_anti_cheat': 'Anti-Cheat (Èò≤‰ΩúÂºäÊ£ÄÊµã)'
            };

            // Parameter descriptions in Chinese
            const parameterDescriptions = {
                'threshold': 'ÊéßÂà∂Âä®‰ΩúÊ£ÄÊµãÁöÑÊïèÊÑüÂ∫¶ÔºåÂÄºË∂äÂ∞èË∂äÂÆπÊòìËß¶ÂèëËÆ°Êï∞',
                'confidence_threshold': 'YOLOÁõÆÊ†áÊ£ÄÊµãÁöÑÊúÄÂ∞èÁΩÆ‰ø°Â∫¶Ë¶ÅÊ±Ç (0.0-1.0)',
                'validation_threshold': 'Âä®‰ΩúÈ™åËØÅÁöÑ‰∏•Ê†ºÁ®ãÂ∫¶ÔºåÂÄºË∂äÈ´òË¶ÅÊ±ÇË∂ä‰∏•Ê†º',
                'stable_frames': 'Á°ÆËÆ§Âä®‰ΩúÈúÄË¶ÅÁöÑËøûÁª≠Ê£ÄÊµãÂ∏ßÊï∞ÔºåÂ¢ûÂä†ÂèØÂáèÂ∞ëËØØÂà§',
                'calibration_frames': 'Ëá™Âä®Ê†°ÂáÜÈò∂ÊÆµÈúÄË¶ÅÈááÈõÜÁöÑÂ∏ßÊï∞Èáè',
                'min_visibility': '‰∫∫‰ΩìÂÖ≥ÈîÆÁÇπÁöÑÊúÄÂ∞èÂèØËßÅÂ∫¶Ë¶ÅÊ±Ç (0.0-1.0)',
                'enable_anti_cheat': 'ÂêØÁî®È¢ùÂ§ñÁöÑÂä®‰ΩúÈ™åËØÅÊú∫Âà∂ÔºåÈò≤Ê≠¢Êó†ÊïàËÆ°Êï∞'
            };

            // Define parameter priority order (most important first)
            const parameterOrder = [
                'threshold',
                'confidence_threshold', 
                'validation_threshold',
                'stable_frames',
                'calibration_frames',
                'min_visibility',
                'enable_anti_cheat'
            ];

            // Sort parameters by priority, then add any remaining ones
            const sortedParams = [];
            
            // Add parameters in priority order
            parameterOrder.forEach(param => {
                if (parameters[param]) {
                    sortedParams.push([param, parameters[param]]);
                }
            });
            
            // Add any remaining parameters not in the priority list
            Object.entries(parameters).forEach(([param, config]) => {
                if (!parameterOrder.includes(param)) {
                    sortedParams.push([param, config]);
                }
            });

            sortedParams.forEach(([param, config]) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                
                const displayName = parameterNames[param] || `${param} (${param})`;
                const description = parameterDescriptions[param] || '';
                
                if (config.type === 'bool') {
                    div.innerHTML = `
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="${param}" ${config.default ? 'checked' : ''}>
                            <span>${displayName}</span>
                        </label>
                        <div style="font-size: 0.8em; color: #666; margin-top: 4px; margin-left: 24px;">
                            ${description}
                        </div>
                    `;
                } else {
                    const maxValue = config.type === 'int' ? '100' : '10';
                    const stepValue = config.type === 'int' ? '1' : '0.01';
                    
                    div.innerHTML = `
                        <label>${displayName}:</label>
                        <div style="font-size: 0.8em; color: #666; margin: 4px 0;">
                            ${description}
                        </div>
                        <div class="parameter-input">
                            <input type="range" id="${param}" min="0" max="${maxValue}" 
                                   step="${stepValue}" value="${config.default}">
                            <span class="range-value" id="${param}Value">${config.default}</span>
                        </div>
                    `;
                }
                
                container.appendChild(div);
            });
            
            // Ê∑ªÂä†ÂèÇÊï∞ÊªëÂùó‰∫ã‰ª∂
            container.querySelectorAll('input[type="range"]').forEach(slider => {
                const valueSpan = document.getElementById(slider.id + 'Value');
                slider.addEventListener('input', function() {
                    if (valueSpan) valueSpan.textContent = this.value;
                    
                    // ÂÆûÊó∂ÂèÇÊï∞Ë∞ÉÊï¥
                    if (isRunning) {
                        if (sliderTimeout) clearTimeout(sliderTimeout);
                        sliderTimeout = setTimeout(() => {
                            updateParameterRealtime(this.id, this.value);
                        }, 300);
                    }
                });
            });
            
            // Ê∑ªÂä†Â§çÈÄâÊ°Ü‰∫ã‰ª∂
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (isRunning) {
                        updateParameterRealtime(this.id, this.checked);
                    }
                });
            });
        }

        async function startCounter() {
            if (!selectedCounter) {
                showMessage('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÆ°Êï∞Âô®', 'error');
                return;
            }

            try {
                const videoSource = getVideoSource();
                const parameters = getParameters();

                const response = await fetch('/start_counter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        counter: selectedCounter,
                        video_source: videoSource,
                        parameters: parameters
                    })
                });

                const result = await response.json();
                
                        if (result.success) {
                    isRunning = true;
                    updateButtonStates();
                    startVideoFeed();
                    startStatusUpdates();
                            showMessage(result.message, 'success');
                        } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`ÂêØÂä®Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        async function stopCounter() {
            try {
                const response = await fetch('/stop_counter', { method: 'POST' });
                const result = await response.json();
                
                isRunning = false;
                updateButtonStates();
                stopVideoFeed();
                stopStatusUpdates();
                showMessage('ËÆ°Êï∞Âô®Â∑≤ÂÅúÊ≠¢', 'success');
            } catch (error) {
                showMessage(`ÂÅúÊ≠¢Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        async function saveSession() {
            try {
                const response = await fetch('/save_session', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`‰ºöËØùÂ∑≤‰øùÂ≠ò: ${result.filename}`, 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`‰øùÂ≠òÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        function getVideoSource() {
            const select = document.getElementById('videoSource');
            if (select.value === 'uploaded') {
                const uploadedSelect = document.getElementById('uploadedVideoSelect');
                return uploadedSelect.value || '0';
            }
            return select.value;
        }

        function getParameters() {
            const parameters = {};
            const inputs = document.querySelectorAll('#parameterControls input');
            
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    parameters[input.id] = input.checked;
                } else if (input.type === 'range') {
                    parameters[input.id] = parseFloat(input.value);
                }
            });
            
            return parameters;
        }

        function updateButtonStates() {
            document.getElementById('startBtn').disabled = isRunning;
            document.getElementById('stopBtn').disabled = !isRunning;
                    document.getElementById('saveBtn').disabled = false;
                    
            // ÂΩïÂà∂ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('startRecordingBtn').disabled = !isRunning || isRecording;
            document.getElementById('stopRecordingBtn').disabled = !isRecording;
            // ‰∏ãËΩΩÊåâÈíÆÂú®ÂΩïÂà∂ÂÅúÊ≠¢ÂêéÊâãÂä®ÂêØÁî®ÔºåËøôÈáå‰∏çÊîπÂèòÁä∂ÊÄÅ
        }

        function startVideoFeed() {
                    const videoFeed = document.getElementById('videoFeed');
                    const placeholder = document.getElementById('videoPlaceholder');
                    
                    videoFeed.src = '/video_feed';
                    videoFeed.classList.remove('video-hidden');
                    videoFeed.classList.add('video-visible');
                    placeholder.classList.remove('video-visible');
                    placeholder.classList.add('video-hidden');
        }

        function stopVideoFeed() {
            const videoFeed = document.getElementById('videoFeed');
            const placeholder = document.getElementById('videoPlaceholder');
            
            videoFeed.src = '';
            videoFeed.classList.add('video-hidden');
            placeholder.classList.remove('video-hidden');
            placeholder.classList.add('video-visible');
        }

        function startStatusUpdates() {
            updateInterval = setInterval(updateStatus, 1000);
        }

        function stopStatusUpdates() {
                    if (updateInterval) {
                        clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/get_session_data');
                const data = await response.json();
                
                document.getElementById('currentCount').textContent = `ËÆ°Êï∞: ${data.current_count || 0}`;
                
                // Update center line slider if YOLO counter is running
                if (isRunning && selectedCounterType === 'yolo') {
                    await updateCenterLineSliderFromCounter();
                }
            } catch (error) {
                console.error('Áä∂ÊÄÅÊõ¥Êñ∞Â§±Ë¥•:', error);
            }
        }

        // Êõ¥Êñ∞‰∏≠ÂøÉÁ∫øÊªëÂùóÂÄº‰ª•ÂåπÈÖçËÆ°Êï∞Âô®ÁöÑÂÆûÈôÖÂÄº
        async function updateCenterLineSliderFromCounter() {
            try {
                const response = await fetch('/get_center_line_position');
                const data = await response.json();
                
                if (data.success && data.calibrated) {
                    const centerLineSlider = document.getElementById('centerLineSlider');
                    const centerLineValue = document.getElementById('centerLineSliderValue');
                    
                    if (centerLineSlider && centerLineValue) {
                        // Only set slider value if it's not already initialized or if the value has changed significantly
                        const currentSliderValue = parseInt(centerLineSlider.value);
                        const actualPosition = Math.round(data.position);
                        
                        if (!centerLineSlider.dataset.initialized || Math.abs(currentSliderValue - actualPosition) > 50) {
                            // Ensure the actual position is within slider range
                            const clampedPosition = Math.max(50, Math.min(2000, actualPosition));
                            centerLineSlider.value = clampedPosition;
                            centerLineValue.textContent = clampedPosition;
                            centerLineSlider.dataset.initialized = 'true';
                            console.log(`üéöÔ∏è ÊªëÂùóÂàùÂßãÂåñ‰∏∫‰∏≠ÂøÉÁ∫ø‰ΩçÁΩÆ: ${clampedPosition} (ÂÆûÈôÖ: ${actualPosition})`);
                            
                            // Warn if position is outside slider range
                            if (actualPosition > 2000) {
                                console.warn(`‚ö†Ô∏è ‰∏≠ÂøÉÁ∫ø‰ΩçÁΩÆ ${actualPosition} Ë∂ÖÂá∫ÊªëÂùóÊúÄÂ§ßÂÄº 2000ÔºåËØ∑‰ΩøÁî®ÊåâÈíÆË∞ÉÊï¥`);
                            } else if (actualPosition < 50) {
                                console.warn(`‚ö†Ô∏è ‰∏≠ÂøÉÁ∫ø‰ΩçÁΩÆ ${actualPosition} ‰Ωé‰∫éÊªëÂùóÊúÄÂ∞èÂÄº 50ÔºåËØ∑‰ΩøÁî®ÊåâÈíÆË∞ÉÊï¥`);
                            }
                        }
                    }
                }
            } catch (error) {
                // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±Âìç‰∏ªË¶ÅÂäüËÉΩ
            }
        }

        // Ë∞ÉÊï¥ÂáΩÊï∞ - ÁÆÄÂåñÁâàÊú¨
        async function adjustCenterLine(adjustment) {
            await makeAdjustment('/adjust_center_line', { adjustment });
        }

        async function adjustCenterLineAbsolute(position) {
            await makeAdjustment('/adjust_center_line_absolute', { position });
        }

        async function adjustSensitivityAbsolute(value) {
            await makeAdjustment('/adjust_sensitivity_absolute', { value });
        }

        async function resetCalibration() {
            const result = await makeAdjustment('/reset_calibration', {});
            
            // Reset slider initialization flag so it can be re-initialized after calibration
            const centerLineSlider = document.getElementById('centerLineSlider');
            if (centerLineSlider) {
                centerLineSlider.dataset.initialized = 'false';
                // Reset slider to middle of range for better coverage
                centerLineSlider.value = 1000;  // Middle of 50-2000 range
                document.getElementById('centerLineSliderValue').textContent = '1000';
            }
            
            // Reset sensitivity slider to default
            const sensitivitySlider = document.getElementById('sensitivitySlider');
            if (sensitivitySlider) {
                sensitivitySlider.value = 1.0;
                document.getElementById('sensitivitySliderValue').textContent = '1.0';
            }
            
            // Reset count display
            document.getElementById('currentCount').textContent = 'ËÆ°Êï∞: 0';
            
            return result;
        }

        async function makeAdjustment(endpoint, data) {
            if (!isRunning) {
                showMessage('ËØ∑ÂÖàÂêØÂä®ËÆ°Êï∞Âô®', 'error');
                return;
            }

            if (selectedCounterType !== 'yolo' && endpoint.includes('center_line')) {
                showMessage('Âè™ÊúâYOLOËÆ°Êï∞Âô®ÊîØÊåÅ‰∏≠ÂøÉÁ∫øË∞ÉÊï¥', 'error');
                return;
            }

            try {
                console.log(`ÂèëÈÄÅË∞ÉÊï¥ËØ∑Ê±Ç: ${endpoint}`, data);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('Ë∞ÉÊï¥ÂìçÂ∫î:', result);
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // Êõ¥Êñ∞ÊªëÂùóÊòæÁ§∫
                    if (result.new_center_line && document.getElementById('centerLineSlider')) {
                        document.getElementById('centerLineSlider').value = result.new_center_line;
                        document.getElementById('centerLineSliderValue').textContent = result.new_center_line;
                    }
                } else {
                    showMessage(result.error || 'Ë∞ÉÊï¥Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ë∞ÉÊï¥Â§±Ë¥•:', error);
                showMessage(`Ë∞ÉÊï¥Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÈîÆÁõòÊéßÂà∂
        function handleKeyboard(event) {
            if (!isRunning || selectedCounterType !== 'yolo') return;

            const keyActions = {
                'KeyW': () => adjustCenterLine(-0.05),
                'ArrowUp': () => adjustCenterLine(-0.05),
                'KeyS': () => adjustCenterLine(0.05),
                'ArrowDown': () => adjustCenterLine(0.05),
                'Equal': () => adjustSensitivity('decrease'),
                'Minus': () => adjustSensitivity('increase'),
                'Digit0': () => resetCalibration()
            };

            if (keyActions[event.code]) {
                event.preventDefault();
                keyActions[event.code]();
                console.log(`ÈîÆÁõòÂø´Êç∑ÈîÆ: ${event.code}`);
            }
        }
        
        async function adjustSensitivity(direction) {
            await makeAdjustment('/adjust_sensitivity', { direction });
        }

        // ÂÆûÊó∂ÂèÇÊï∞Êõ¥Êñ∞
        async function updateParameterRealtime(paramName, paramValue) {
            try {
                console.log(`ÂÆûÊó∂Êõ¥Êñ∞ÂèÇÊï∞: ${paramName} = ${paramValue}`);
                const response = await fetch('/update_parameter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parameter: paramName,
                        value: paramValue
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`ÂèÇÊï∞Êõ¥Êñ∞ÊàêÂäü: ${result.message}`);
                    // ÂèØÈÄâÔºöÊòæÁ§∫ÁÆÄÁü≠ÁöÑÊàêÂäüÊ∂àÊÅØ
                    // showMessage(result.message, 'success');
                } else {
                    console.error('ÂèÇÊï∞Êõ¥Êñ∞Â§±Ë¥•:', result.error);
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('ÂèÇÊï∞Êõ¥Êñ∞ËØ∑Ê±ÇÂ§±Ë¥•:', error);
                showMessage(`ÂèÇÊï∞Êõ¥Êñ∞Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Êñá‰ª∂‰∏ä‰º†
        async function uploadVideo() {
            const fileInput = document.getElementById('videoFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;

            const formData = new FormData();
            formData.append('video_file', file);

            try {
                showMessage('‰∏ä‰º†‰∏≠...', 'success');
                const response = await fetch('/upload_video', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // Ëá™Âä®ÂàáÊç¢Âà∞Â∑≤‰∏ä‰º†ËßÜÈ¢ëÂπ∂Âà∑Êñ∞ÂàóË°®
                    document.getElementById('videoSource').value = 'uploaded';
                    document.getElementById('uploadVideoGroup').classList.add('hidden');
                    document.getElementById('uploadedVideoGroup').classList.remove('hidden');
                    await loadUploadedVideos();
                    // Ëá™Âä®ÈÄâÊã©Âàö‰∏ä‰º†ÁöÑËßÜÈ¢ë
                    document.getElementById('uploadedVideoSelect').value = result.filepath;
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Âä†ËΩΩÂ∑≤‰∏ä‰º†ËßÜÈ¢ëÂàóË°®
        async function loadUploadedVideos() {
            try {
                const response = await fetch('/list_uploaded_videos');
                const data = await response.json();
                
                const select = document.getElementById('uploadedVideoSelect');
                select.innerHTML = '<option value="">-- ÈÄâÊã©Â∑≤‰∏ä‰º†ËßÜÈ¢ë --</option>';
                
                if (data.videos && data.videos.length > 0) {
                    data.videos.forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.filepath;
                        option.textContent = `${video.filename} (${video.size_mb}MB)`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Ê≤°ÊúâÂ∑≤‰∏ä‰º†ÁöÑËßÜÈ¢ë';
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Âä†ËΩΩËßÜÈ¢ëÂàóË°®Â§±Ë¥•:', error);
                showMessage('Âä†ËΩΩËßÜÈ¢ëÂàóË°®Â§±Ë¥•', 'error');
            }
        }
        
        // ÂΩïÂà∂ÂäüËÉΩ
        async function startRecording() {
                if (!isRunning) {
                showMessage('ËØ∑ÂÖàÂêØÂä®ËÆ°Êï∞Âô®', 'error');
                    return;
                }
                
            try {
                const response = await fetch('/start_recording', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    isRecording = true;
                    updateButtonStates();
                    updateRecordingStatus('üî¥ ÂΩïÂà∂‰∏≠...', 'recording');
                    showMessage('ÂΩïÂà∂Â∑≤ÂºÄÂßã', 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`ÂΩïÂà∂ÂêØÂä®Â§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        async function stopRecording() {
            try {
                const response = await fetch('/stop_recording', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    isRecording = false;
                    updateButtonStates();
                    
                    // Show detailed recording information
                    const fileInfo = result.file_size_mb > 0 
                        ? `‚úÖ ÂΩïÂà∂ÂÆåÊàê: ${result.filename} (${result.file_size_mb}MB, ${result.duration}s)`
                        : `‚ö†Ô∏è ÂΩïÂà∂ÂÆåÊàê‰ΩÜÊñá‰ª∂‰∏∫Á©∫: ${result.filename} (0MB)`;
                    
                    updateRecordingStatus(fileInfo, result.file_size_mb > 0 ? 'completed' : 'warning');
                    
                    // Only enable download if file has content
                    document.getElementById('downloadRecordingBtn').disabled = result.file_size_mb <= 0;
                    
                    const message = result.file_size_mb > 0 
                        ? `ÂΩïÂà∂Â∑≤ÂÅúÊ≠¢: ${result.filename} (${result.file_size_mb}MB)`
                        : `ÂΩïÂà∂ÂÅúÊ≠¢Ôºå‰ΩÜÊñá‰ª∂‰∏∫Á©∫„ÄÇËØ∑Ê£ÄÊü•ÂΩïÂà∂ËÆæÁΩÆÂíåÁºñËß£Á†ÅÂô®ÊîØÊåÅ„ÄÇ`;
                    
                    showMessage(message, result.file_size_mb > 0 ? 'success' : 'error');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`ÂΩïÂà∂ÂÅúÊ≠¢Â§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        async function downloadRecording() {
            try {
                const response = await fetch('/download_latest_recording');
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const filename = response.headers.get('content-disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'recording.mp4';
                    
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showMessage('ÂΩïÂà∂ËßÜÈ¢ë‰∏ãËΩΩÊàêÂäü!', 'success');
                } else {
                    const error = await response.json();
                    showMessage(error.error || '‰∏ãËΩΩÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showMessage(`‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        function updateRecordingStatus(message, type) {
            const statusDiv = document.getElementById('recordingStatus');
            statusDiv.textContent = message;
            
            if (type === 'recording') {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
            } else if (type === 'completed') {
                statusDiv.style.background = '#e8f5e8';
                statusDiv.style.color = '#2e7d32';
            } else if (type === 'warning') {
                statusDiv.style.background = '#fff3e0';
                statusDiv.style.color = '#ef6c00';
            } else {
                statusDiv.style.background = '#f0f8ff';
                statusDiv.style.color = '#1976d2';
            }
        }

        // Ê∂àÊÅØÊòæÁ§∫
        function showMessage(message, type) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.textContent = message;
            messageDiv.className = `status-message status-${type}`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html> 