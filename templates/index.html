<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠ¨ä½œè®¡æ•°å™¨ - ç½‘é¡µç•Œé¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        
        .main-content {
            display: flex;
            min-height: 700px;
            max-height: 100vh;
        }
        
        .video-section {
            flex: 3;
            padding: 20px;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            max-height: 100vh;
        }
        
        .video-area {
            flex-shrink: 0;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .video-controls-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }
        
        .controls-section {
            flex: 2;
            padding: 20px;
            background-color: #fafafa;
            overflow-y: auto;
            max-height: 100vh;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            height: 380px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #videoFeed {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .video-placeholder {
            width: 100%;
            height: 100%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 1.2em;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s ease;
        }
        
        .count-display {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .count-display h2 {
            margin: 0;
            font-size: 2em;
        }
        
        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 3px;
            font-size: 1em;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        
        select, input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .btn-save {
            background: linear-gradient(135deg, #51cf66, #40c057);
        }
        
        .parameter-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parameter-input input[type="range"] {
            flex: 1;
            height: 6px;
        }
        
        .parameter-input .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 0.85em;
        }
        
        .center-line-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin: 8px 0;
        }
        
        .btn-adjust, .btn-reset {
            flex: 1;
            min-width: 70px;
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-adjust {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-adjust:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }
        
        .btn-reset:hover {
            background: linear-gradient(135deg, #F57C00, #E65100);
            transform: translateY(-1px);
        }
        
        .counter-category {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .counter-category h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .counter-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .video-hidden {
            opacity: 0 !important;
            pointer-events: none;
        }
        
        .video-visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Center line controls styling */
        #centerLineGroup {
            background: #f0f8ff;
            border: 2px solid #4CAF50;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
        }
        
        #centerLineGroup h3 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 0.95em;
        }
        
        .keyboard-controls-info {
            background: #fff9c4;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #FFC107;
            font-family: monospace;
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        kbd {
            background: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .video-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‹ï¸ å¤šåŠ¨ä½œè®¡æ•°å™¨</h1>
            <p>å®æ—¶è¿åŠ¨è®¡æ•°ä¸AIå§¿åŠ¿æ£€æµ‹</p>
        </div>
        
        <div class="main-content">
            <div class="video-section">
                <!-- Fixed Video Area -->
                <div class="video-area">
                    <div class="video-container">
                        <img id="videoFeed" src="" alt="è§†é¢‘æµå°†åœ¨æ­¤æ˜¾ç¤º" class="video-hidden">
                        <div id="videoPlaceholder" class="video-placeholder video-visible">
                            é€‰æ‹©è®¡æ•°å™¨å¹¶ç‚¹å‡»å¼€å§‹
                        </div>
                    </div>
                    
                    <div class="count-display">
                        <h2 id="currentCount">è®¡æ•°: 0</h2>
                        <p id="counterName">æœªé€‰æ‹©è®¡æ•°å™¨</p>
                    </div>
                </div>
                
                <!-- Scrollable Controls Area -->
                <div class="video-controls-area">
                    <!-- Parameters Section -->
                    <div class="control-group" id="parametersGroup">
                        <h3>âš™ï¸ å‚æ•°è®¾ç½®</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                            æ ¹æ®æ‰€é€‰è®¡æ•°å™¨ç±»å‹è°ƒæ•´æ£€æµ‹å‚æ•°ï¼Œæé«˜è®¡æ•°å‡†ç¡®æ€§ï¼š
                        </p>
                        <div id="parameterControls"></div>
                        <div style="font-size: 0.8em; color: #555; margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                            <strong>ğŸ“– å‚æ•°è¯´æ˜ (Parameter Descriptions)ï¼š</strong><br>
                            â€¢ <strong>Threshold (æ£€æµ‹é˜ˆå€¼)</strong>: æœ€é‡è¦å‚æ•°ï¼Œæ§åˆ¶æ£€æµ‹æ•æ„Ÿåº¦ï¼Œå€¼è¶Šå°è¶Šæ•æ„Ÿ<br>
                            â€¢ <strong>Confidence Threshold (ç½®ä¿¡åº¦é˜ˆå€¼)</strong>: YOLOç›®æ ‡æ£€æµ‹çš„æœ€å°ç½®ä¿¡åº¦è¦æ±‚<br>
                            â€¢ <strong>Validation Threshold (éªŒè¯é˜ˆå€¼)</strong>: åŠ¨ä½œéªŒè¯çš„ä¸¥æ ¼ç¨‹åº¦<br>
                            â€¢ <strong>Stable Frames (ç¨³å®šå¸§æ•°)</strong>: éœ€è¦è¿ç»­æ£€æµ‹å¤šå°‘å¸§æ‰ç¡®è®¤åŠ¨ä½œ<br>
                            â€¢ <strong>Calibration Frames (æ ¡å‡†å¸§æ•°)</strong>: è‡ªåŠ¨æ ¡å‡†éœ€è¦çš„å¸§æ•°<br>
                            â€¢ <strong>Min Visibility (æœ€å°å¯è§åº¦)</strong>: äººä½“å…³é”®ç‚¹å¯è§åº¦è¦æ±‚<br>
                            â€¢ <strong>Anti-Cheat (é˜²ä½œå¼Šæ£€æµ‹)</strong>: å¯ç”¨åŠ¨ä½œéªŒè¯æœºåˆ¶
                            </div>
                        </div>
                        
                    <!-- Center Line Controls -->
                    <div class="control-group hidden" id="centerLineGroup">
                        <h3>ğŸ¯ ä¸­å¿ƒçº¿æ§åˆ¶ (YOLOè®¡æ•°å™¨)</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                            è°ƒæ•´YOLOè®¡æ•°å™¨çš„æ£€æµ‹å‚è€ƒçº¿ä½ç½®ï¼Œç”¨äºåŠ¨ç‰©è·³è·ƒå’Œç‰©ä½“å¼¹è·³æ£€æµ‹ï¼š
                        </p>
                        
                        <div class="form-group">
                            <label for="centerLineSlider">
                                Center Line Position (ä¸­å¿ƒçº¿ä½ç½®) - Pixels:
                                <span style="font-size: 0.8em; color: #888;">è°ƒæ•´æ£€æµ‹çš„ç›®æ ‡ä½ç½®</span>
                            </label>
                            <div class="parameter-input">
                                <input type="range" id="centerLineSlider" min="50" max="2000" step="10" value="1000">
                                <span class="range-value" id="centerLineSliderValue">1000</span>
                            </div>
                            <div style="font-size: 0.8em; color: #555; margin-top: 5px;">
                                â€¢ Animal Counters (åŠ¨ç‰©è®¡æ•°å™¨)ï¼šè®¾ç½®è·³è·ƒç›®æ ‡çº¿é«˜åº¦<br>
                                â€¢ Object Counters (ç‰©ä½“è®¡æ•°å™¨)ï¼šè®¾ç½®åœ°é¢å‚è€ƒçº¿ä½ç½®
                        </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="sensitivitySlider">
                                Sensitivity Multiplier (æ£€æµ‹çµæ•åº¦) - Factor:
                                <span style="font-size: 0.8em; color: #888;">è°ƒæ•´æ£€æµ‹åŒºåŸŸå¤§å°</span>
                            </label>
                            <div class="parameter-input">
                                <input type="range" id="sensitivitySlider" min="0.3" max="3.0" step="0.1" value="1.0">
                                <span class="range-value" id="sensitivitySliderValue">1.0</span>
                            </div>
                            <div style="font-size: 0.8em; color: #555; margin-top: 5px;">
                                â€¢ Lower Value (å€¼è¶Šå°)ï¼šæ£€æµ‹è¶Šæ•æ„Ÿï¼Œæ›´å®¹æ˜“è§¦å‘è®¡æ•°<br>
                                â€¢ Higher Value (å€¼è¶Šå¤§)ï¼šæ£€æµ‹è¶Šå®½æ¾ï¼Œéœ€è¦æ›´æ˜æ˜¾çš„åŠ¨ä½œ
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Quick Adjustment Buttons (å¿«é€Ÿè°ƒæ•´æŒ‰é’®):</label>
                            <div class="center-line-controls">
                                <button type="button" onclick="adjustCenterLine(-0.05)" class="btn-adjust" title="å‘ä¸Šç§»åŠ¨ä¸­å¿ƒçº¿10åƒç´ ">â¬†ï¸ Up (å‘ä¸Š)</button>
                                <button type="button" onclick="adjustCenterLine(0.05)" class="btn-adjust" title="å‘ä¸‹ç§»åŠ¨ä¸­å¿ƒçº¿10åƒç´ ">â¬‡ï¸ Down (å‘ä¸‹)</button>
                                <button type="button" onclick="resetCalibration()" class="btn-reset" title="é‡æ–°è‡ªåŠ¨æ ¡å‡†æ£€æµ‹çº¿">ğŸ”„ Reset (é‡ç½®æ ¡å‡†)</button>
                            </div>
                            <div style="font-size: 0.8em; color: #555; margin-top: 5px;">
                                æ¯æ¬¡ç‚¹å‡»è°ƒæ•´çº¦10åƒç´ ï¼Œç”¨äºç²¾ç»†è°ƒèŠ‚æ£€æµ‹ä½ç½®
                        </div>
                    </div>
                    
                        <div class="keyboard-controls-info">
                            <p><strong>ğŸ® é”®ç›˜å¿«æ·é”®æ§åˆ¶:</strong></p>
                            <p><kbd>W</kbd>/<kbd>â†‘</kbd>: ä¸­å¿ƒçº¿ä¸Šç§» | <kbd>S</kbd>/<kbd>â†“</kbd>: ä¸­å¿ƒçº¿ä¸‹ç§»</p>
                            <p><kbd>+</kbd>: é™ä½çµæ•åº¦ (å¢å¤§æ£€æµ‹åŒºåŸŸ) | <kbd>-</kbd>: æé«˜çµæ•åº¦ (ç¼©å°æ£€æµ‹åŒºåŸŸ)</p>
                            <p><kbd>0</kbd>: é‡ç½®æ ¡å‡† (æ¢å¤è‡ªåŠ¨æ£€æµ‹)</p>
                            <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                ğŸ’¡ æç¤ºï¼šå¯åŠ¨è®¡æ•°å™¨åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¡å‡†ã€‚å¦‚æœæ£€æµ‹ä¸å‡†ç¡®ï¼Œå¯ä½¿ç”¨ä¸Šè¿°æ§åˆ¶è¿›è¡Œæ‰‹åŠ¨è°ƒæ•´ã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="controls-section">
                <div id="statusMessage" class="status-message hidden"></div>
                
                <div class="control-group">
                    <h3>ğŸ¯ è®¡æ•°å™¨é€‰æ‹©</h3>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        é€‰æ‹©é€‚åˆæ‚¨éœ€æ±‚çš„AIè®¡æ•°å™¨ç±»å‹ï¼š
                    </div>
                    
                    <!-- Human Action Counters -->
                    <div class="counter-category">
                        <h4>ğŸƒâ€â™€ï¸ äººä½“åŠ¨ä½œè®¡æ•°å™¨ (MediaPipe AI)</h4>
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">
                            åŸºäºäººä½“å§¿æ€è¯†åˆ«çš„è¿åŠ¨è®¡æ•°ï¼Œé€‚ç”¨äºå¥èº«è®­ç»ƒå’Œè¿åŠ¨åˆ†æ
                        </div>
                        <div class="form-group">
                            <select id="humanCounterSelect" class="counter-select">
                                <option value="">é€‰æ‹©äººä½“åŠ¨ä½œè®¡æ•°å™¨...</option>
                                {% for counter in counters.Human %}
                                <option value="{{ counter.name }}" data-type="{{ counter.type }}" data-category="human">
                                    {{ counter.name }} - {{ counter.logic_type }}åŠ¨ä½œæ£€æµ‹
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Animal Counters -->
                    <div class="counter-category">
                        <h4>ğŸ¾ åŠ¨ç‰©è®¡æ•°å™¨ (YOLO AI)</h4>
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">
                            åŸºäºç›®æ ‡æ£€æµ‹çš„åŠ¨ç‰©è¡Œä¸ºè®¡æ•°ï¼Œé€‚ç”¨äºå® ç‰©è¿åŠ¨ç›‘æµ‹å’Œç ”ç©¶
                        </div>
                        <div class="form-group">
                            <select id="animalCounterSelect" class="counter-select">
                                <option value="">é€‰æ‹©åŠ¨ç‰©è®¡æ•°å™¨...</option>
                                {% for counter in counters.Animal %}
                                <option value="{{ counter.name }}" data-type="{{ counter.type }}" data-category="animal">
                                    {{ counter.name }} - {{ counter.object_class }}{{ counter.logic_type }}æ£€æµ‹
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Object Counters -->
                    <div class="counter-category">
                        <h4>ğŸ€ ç‰©ä½“è®¡æ•°å™¨ (YOLO AI)</h4>
                        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px;">
                            åŸºäºç›®æ ‡æ£€æµ‹çš„ç‰©ä½“è¿åŠ¨è®¡æ•°ï¼Œé€‚ç”¨äºçƒç±»è¿åŠ¨å’Œç‰©ä½“è¿½è¸ª
                        </div>
                        <div class="form-group">
                            <select id="objectCounterSelect" class="counter-select">
                                <option value="">é€‰æ‹©ç‰©ä½“è®¡æ•°å™¨...</option>
                                {% for counter in counters.Object %}
                                <option value="{{ counter.name }}" data-type="{{ counter.type }}" data-category="object">
                                    {{ counter.name }} - {{ counter.object_class }}{{ counter.logic_type }}æ£€æµ‹
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="videoSource">è§†é¢‘æºé€‰æ‹©:</label>
                        <select id="videoSource">
                            <option value="0">æ‘„åƒå¤´ (æ‘„åƒå¤´ 0) - å®æ—¶æ£€æµ‹</option>
                            <option value="1">æ‘„åƒå¤´ (æ‘„åƒå¤´ 1) - å¤‡ç”¨æ‘„åƒå¤´</option>
                            <option value="upload">ä¸Šä¼ è§†é¢‘æ–‡ä»¶ - åˆ†æå½•åˆ¶è§†é¢‘</option>
                            <option value="uploaded">ä½¿ç”¨å·²ä¸Šä¼ è§†é¢‘ - é€‰æ‹©å†å²è§†é¢‘</option>
                        </select>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            ğŸ’¡ æç¤ºï¼šæ‘„åƒå¤´ç”¨äºå®æ—¶æ£€æµ‹ï¼Œä¸Šä¼ è§†é¢‘ç”¨äºåˆ†æå·²å½•åˆ¶çš„è¿åŠ¨è§†é¢‘
                        </div>
                    </div>
                    
                    <div class="form-group hidden" id="uploadVideoGroup">
                        <label>ä¸Šä¼ æ–°è§†é¢‘æ–‡ä»¶:</label>
                        <input type="file" id="videoFileInput" accept=".mp4,.avi,.mov,.mkv,.wmv,.flv,.webm,.m4v">
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            æ”¯æŒæ ¼å¼ï¼šMP4, AVI, MOV, MKV, WMV, FLV, WebM, M4V<br>
                            æ¨èä½¿ç”¨MP4æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°é™åˆ¶100MB
                        </div>
                    </div>
                    
                    <div class="form-group hidden" id="uploadedVideoGroup">
                        <label for="uploadedVideoSelect">é€‰æ‹©å·²ä¸Šä¼ çš„è§†é¢‘:</label>
                        <select id="uploadedVideoSelect">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                        <button type="button" onclick="loadUploadedVideos()" style="margin-top: 5px; padding: 5px 10px; font-size: 12px;">ğŸ”„ åˆ·æ–°è§†é¢‘åˆ—è¡¨</button>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            é€‰æ‹©ä¹‹å‰ä¸Šä¼ çš„è§†é¢‘æ–‡ä»¶è¿›è¡Œé‡æ–°åˆ†æ
                    </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ® è®¡æ•°æ§åˆ¶</h3>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        æ§åˆ¶è®¡æ•°å™¨çš„å¯åŠ¨ã€åœæ­¢å’Œæ•°æ®ä¿å­˜ï¼š
                    </div>
                    <button id="startBtn" onclick="startCounter()" title="å¼€å§‹è§†é¢‘å¤„ç†å’ŒåŠ¨ä½œè®¡æ•°">ğŸš€ å¼€å§‹è®¡æ•°</button>
                    <button id="stopBtn" onclick="stopCounter()" class="btn-stop" disabled title="åœæ­¢å½“å‰çš„è®¡æ•°ä¼šè¯">â¹ï¸ åœæ­¢è®¡æ•°</button>
                    <button id="saveBtn" onclick="saveSession()" class="btn-save" disabled title="ä¿å­˜å½“å‰è®¡æ•°ä¼šè¯æ•°æ®åˆ°æ–‡ä»¶">ğŸ’¾ ä¿å­˜ä¼šè¯æ•°æ®</button>
                    <div style="font-size: 0.8em; color: #555; margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                        <strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                        1. é€‰æ‹©è®¡æ•°å™¨ç±»å‹å’Œè§†é¢‘æº<br>
                        2. è°ƒæ•´å‚æ•°è®¾ç½®ï¼ˆå¯é€‰ï¼‰<br>
                        3. ç‚¹å‡»"å¼€å§‹è®¡æ•°"å¯åŠ¨æ£€æµ‹<br>
                        4. ç³»ç»Ÿè‡ªåŠ¨æ ¡å‡†åå¼€å§‹è®¡æ•°<br>
                        5. å¯éšæ—¶ä¿å­˜ä¼šè¯æ•°æ®
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ“¹ è§†é¢‘å½•åˆ¶</h3>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        å½•åˆ¶å¸¦æœ‰è®¡æ•°ä¿¡æ¯çš„å¤„ç†åè§†é¢‘ï¼š
                    </div>
                    <button id="startRecordingBtn" onclick="startRecording()" disabled title="å¼€å§‹å½•åˆ¶å½“å‰çš„è§†é¢‘å¤„ç†ç”»é¢">ğŸ”´ å¼€å§‹å½•åˆ¶</button>
                    <button id="stopRecordingBtn" onclick="stopRecording()" class="btn-stop" disabled title="åœæ­¢å½•åˆ¶å¹¶ä¿å­˜è§†é¢‘æ–‡ä»¶">â¹ï¸ åœæ­¢å½•åˆ¶</button>
                    <button id="downloadRecordingBtn" onclick="downloadRecording()" class="btn-save" disabled title="ä¸‹è½½æœ€è¿‘å½•åˆ¶çš„è§†é¢‘æ–‡ä»¶">ğŸ’¾ ä¸‹è½½å½•åˆ¶è§†é¢‘</button>
                    <div id="recordingStatus" style="margin-top: 10px; padding: 8px; background: #f0f8ff; border-radius: 4px; font-size: 0.9em; text-align: center;">å‡†å¤‡å½•åˆ¶</div>
                    <div style="font-size: 0.8em; color: #555; margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                        <strong>ğŸ¬ å½•åˆ¶è¯´æ˜ï¼š</strong><br>
                        â€¢ å½•åˆ¶çš„è§†é¢‘åŒ…å«æ£€æµ‹çº¿ã€è®¡æ•°ä¿¡æ¯å’Œæ£€æµ‹æ¡†<br>
                        â€¢ è§†é¢‘æ ¼å¼ï¼šMP4ï¼Œå¸§ç‡ï¼š25fps<br>
                        â€¢ åˆ†è¾¨ç‡ï¼šä¸ç½‘é¡µæ˜¾ç¤ºä¸€è‡´ï¼ˆæœ€å¤§640pxå®½åº¦ï¼‰<br>
                        â€¢ å½•åˆ¶æ–‡ä»¶ä¿å­˜åœ¨recordingsæ–‡ä»¶å¤¹ä¸­
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let isRunning = false;
        let updateInterval;
        let selectedCounter = '';
        let selectedCounterType = '';
        let sliderTimeout = null;
        let isRecording = false;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateParameterControls();
            loadUploadedVideos();
        });
        
        function setupEventListeners() {
            // è®¡æ•°å™¨é€‰æ‹©äº‹ä»¶
            document.getElementById('humanCounterSelect').addEventListener('change', handleCounterSelection);
            document.getElementById('animalCounterSelect').addEventListener('change', handleCounterSelection);
            document.getElementById('objectCounterSelect').addEventListener('change', handleCounterSelection);
            
            // é”®ç›˜æ§åˆ¶
            document.addEventListener('keydown', handleKeyboard);
            
            // è§†é¢‘æºåˆ‡æ¢
            document.getElementById('videoSource').addEventListener('change', function() {
                const uploadGroup = document.getElementById('uploadVideoGroup');
                const uploadedGroup = document.getElementById('uploadedVideoGroup');
                
                // éšè—æ‰€æœ‰ç»„
                uploadGroup.classList.add('hidden');
                uploadedGroup.classList.add('hidden');
                
                if (this.value === 'upload') {
                    uploadGroup.classList.remove('hidden');
                } else if (this.value === 'uploaded') {
                    uploadedGroup.classList.remove('hidden');
                    loadUploadedVideos();
                }
            });
            
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('videoFileInput').addEventListener('change', uploadVideo);
            
            // æ»‘å—äº‹ä»¶
            setupSliders();
        }

        function setupSliders() {
            const centerLineSlider = document.getElementById('centerLineSlider');
            const sensitivitySlider = document.getElementById('sensitivitySlider');
            
            if (centerLineSlider) {
                centerLineSlider.addEventListener('input', function() {
                    document.getElementById('centerLineSliderValue').textContent = this.value;
                    
                    if (sliderTimeout) clearTimeout(sliderTimeout);
                    sliderTimeout = setTimeout(() => {
                        if (isRunning && selectedCounterType === 'yolo') {
                            adjustCenterLineAbsolute(parseFloat(this.value));
                        }
                    }, 300);
                });
            }
            
            if (sensitivitySlider) {
                sensitivitySlider.addEventListener('input', function() {
                    document.getElementById('sensitivitySliderValue').textContent = this.value;
                    
                    if (sliderTimeout) clearTimeout(sliderTimeout);
                    sliderTimeout = setTimeout(() => {
                        if (isRunning && selectedCounterType === 'yolo') {
                            adjustSensitivityAbsolute(parseFloat(this.value));
                        }
                    }, 300);
                });
            }
        }
        
        function handleCounterSelection(event) {
            // æ¸…é™¤å…¶ä»–é€‰æ‹©
            const selects = ['humanCounterSelect', 'animalCounterSelect', 'objectCounterSelect'];
            selects.forEach(selectId => {
                if (selectId !== event.target.id) {
                    document.getElementById(selectId).value = '';
                }
            });
            
            const option = event.target.selectedOptions[0];
            if (option && option.value) {
                selectedCounter = option.value;
                selectedCounterType = option.dataset.type;
                
                // æ˜¾ç¤º/éšè—ä¸­å¿ƒçº¿æ§åˆ¶
            const centerLineGroup = document.getElementById('centerLineGroup');
            if (selectedCounterType === 'yolo') {
                centerLineGroup.classList.remove('hidden');
            } else {
                centerLineGroup.classList.add('hidden');
            }
            
                // åŠ è½½è®¡æ•°å™¨ä¿¡æ¯
                loadCounterInfo(selectedCounter);
                
                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('counterName').textContent = selectedCounter;
            } else {
                selectedCounter = '';
                selectedCounterType = '';
                document.getElementById('centerLineGroup').classList.add('hidden');
                document.getElementById('counterName').textContent = 'æœªé€‰æ‹©è®¡æ•°å™¨';
            }
        }

        async function loadCounterInfo(counterName) {
            try {
                const response = await fetch(`/get_counter_info/${counterName}`);
                const info = await response.json();
                
                if (info.error) {
                    showMessage(info.error, 'error');
                    return;
                }

                updateParameterControls(info.parameters);
            } catch (error) {
                showMessage(`åŠ è½½è®¡æ•°å™¨ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function updateParameterControls(parameters = {}) {
            const container = document.getElementById('parameterControls');
            container.innerHTML = '';

            // English(Chinese) parameter name mapping with priority order
            const parameterNames = {
                'threshold': 'Threshold (æ£€æµ‹é˜ˆå€¼)',
                'confidence_threshold': 'Confidence Threshold (ç½®ä¿¡åº¦é˜ˆå€¼)',
                'validation_threshold': 'Validation Threshold (éªŒè¯é˜ˆå€¼)',
                'stable_frames': 'Stable Frames (ç¨³å®šå¸§æ•°)',
                'calibration_frames': 'Calibration Frames (æ ¡å‡†å¸§æ•°)',
                'min_visibility': 'Min Visibility (æœ€å°å¯è§åº¦)',
                'enable_anti_cheat': 'Anti-Cheat (é˜²ä½œå¼Šæ£€æµ‹)'
            };

            // Parameter descriptions in Chinese
            const parameterDescriptions = {
                'threshold': 'æ§åˆ¶åŠ¨ä½œæ£€æµ‹çš„æ•æ„Ÿåº¦ï¼Œå€¼è¶Šå°è¶Šå®¹æ˜“è§¦å‘è®¡æ•°',
                'confidence_threshold': 'YOLOç›®æ ‡æ£€æµ‹çš„æœ€å°ç½®ä¿¡åº¦è¦æ±‚ (0.0-1.0)',
                'validation_threshold': 'åŠ¨ä½œéªŒè¯çš„ä¸¥æ ¼ç¨‹åº¦ï¼Œå€¼è¶Šé«˜è¦æ±‚è¶Šä¸¥æ ¼',
                'stable_frames': 'ç¡®è®¤åŠ¨ä½œéœ€è¦çš„è¿ç»­æ£€æµ‹å¸§æ•°ï¼Œå¢åŠ å¯å‡å°‘è¯¯åˆ¤',
                'calibration_frames': 'è‡ªåŠ¨æ ¡å‡†é˜¶æ®µéœ€è¦é‡‡é›†çš„å¸§æ•°é‡',
                'min_visibility': 'äººä½“å…³é”®ç‚¹çš„æœ€å°å¯è§åº¦è¦æ±‚ (0.0-1.0)',
                'enable_anti_cheat': 'å¯ç”¨é¢å¤–çš„åŠ¨ä½œéªŒè¯æœºåˆ¶ï¼Œé˜²æ­¢æ— æ•ˆè®¡æ•°'
            };

            // Define parameter priority order (most important first)
            const parameterOrder = [
                'threshold',
                'confidence_threshold', 
                'validation_threshold',
                'stable_frames',
                'calibration_frames',
                'min_visibility',
                'enable_anti_cheat'
            ];

            // Sort parameters by priority, then add any remaining ones
            const sortedParams = [];
            
            // Add parameters in priority order
            parameterOrder.forEach(param => {
                if (parameters[param]) {
                    sortedParams.push([param, parameters[param]]);
                }
            });
            
            // Add any remaining parameters not in the priority list
            Object.entries(parameters).forEach(([param, config]) => {
                if (!parameterOrder.includes(param)) {
                    sortedParams.push([param, config]);
                }
            });

            sortedParams.forEach(([param, config]) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                
                const displayName = parameterNames[param] || `${param} (${param})`;
                const description = parameterDescriptions[param] || '';
                
                if (config.type === 'bool') {
                    div.innerHTML = `
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="${param}" ${config.default ? 'checked' : ''}>
                            <span>${displayName}</span>
                        </label>
                        <div style="font-size: 0.8em; color: #666; margin-top: 4px; margin-left: 24px;">
                            ${description}
                        </div>
                    `;
                } else {
                    const maxValue = config.type === 'int' ? '100' : '10';
                    const stepValue = config.type === 'int' ? '1' : '0.01';
                    
                    div.innerHTML = `
                        <label>${displayName}:</label>
                        <div style="font-size: 0.8em; color: #666; margin: 4px 0;">
                            ${description}
                        </div>
                        <div class="parameter-input">
                            <input type="range" id="${param}" min="0" max="${maxValue}" 
                                   step="${stepValue}" value="${config.default}">
                            <span class="range-value" id="${param}Value">${config.default}</span>
                        </div>
                    `;
                }
                
                container.appendChild(div);
            });
            
            // æ·»åŠ å‚æ•°æ»‘å—äº‹ä»¶
            container.querySelectorAll('input[type="range"]').forEach(slider => {
                const valueSpan = document.getElementById(slider.id + 'Value');
                slider.addEventListener('input', function() {
                    if (valueSpan) valueSpan.textContent = this.value;
                    
                    // å®æ—¶å‚æ•°è°ƒæ•´
                    if (isRunning) {
                        if (sliderTimeout) clearTimeout(sliderTimeout);
                        sliderTimeout = setTimeout(() => {
                            updateParameterRealtime(this.id, this.value);
                        }, 300);
                    }
                });
            });
            
            // æ·»åŠ å¤é€‰æ¡†äº‹ä»¶
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (isRunning) {
                        updateParameterRealtime(this.id, this.checked);
                    }
                });
            });
        }

        async function startCounter() {
            if (!selectedCounter) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¡æ•°å™¨', 'error');
                return;
            }

            try {
                const videoSource = getVideoSource();
                const parameters = getParameters();

                const response = await fetch('/start_counter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        counter: selectedCounter,
                        video_source: videoSource,
                        parameters: parameters
                    })
                });

                const result = await response.json();
                
                        if (result.success) {
                    isRunning = true;
                    updateButtonStates();
                    startVideoFeed();
                    startStatusUpdates();
                            showMessage(result.message, 'success');
                        } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function stopCounter() {
            try {
                const response = await fetch('/stop_counter', { method: 'POST' });
                const result = await response.json();
                
                isRunning = false;
                updateButtonStates();
                stopVideoFeed();
                stopStatusUpdates();
                showMessage('è®¡æ•°å™¨å·²åœæ­¢', 'success');
            } catch (error) {
                showMessage(`åœæ­¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function saveSession() {
            try {
                const response = await fetch('/save_session', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`ä¼šè¯å·²ä¿å­˜: ${result.filename}`, 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function getVideoSource() {
            const select = document.getElementById('videoSource');
            if (select.value === 'uploaded') {
                const uploadedSelect = document.getElementById('uploadedVideoSelect');
                return uploadedSelect.value || '0';
            }
            return select.value;
        }

        function getParameters() {
            const parameters = {};
            const inputs = document.querySelectorAll('#parameterControls input');
            
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    parameters[input.id] = input.checked;
                } else if (input.type === 'range') {
                    parameters[input.id] = parseFloat(input.value);
                }
            });
            
            return parameters;
        }

        function updateButtonStates() {
            document.getElementById('startBtn').disabled = isRunning;
            document.getElementById('stopBtn').disabled = !isRunning;
                    document.getElementById('saveBtn').disabled = false;
                    
            // å½•åˆ¶æŒ‰é’®çŠ¶æ€
            document.getElementById('startRecordingBtn').disabled = !isRunning || isRecording;
            document.getElementById('stopRecordingBtn').disabled = !isRecording;
            // ä¸‹è½½æŒ‰é’®åœ¨å½•åˆ¶åœæ­¢åæ‰‹åŠ¨å¯ç”¨ï¼Œè¿™é‡Œä¸æ”¹å˜çŠ¶æ€
        }

        function startVideoFeed() {
                    const videoFeed = document.getElementById('videoFeed');
                    const placeholder = document.getElementById('videoPlaceholder');
                    
                    videoFeed.src = '/video_feed';
                    videoFeed.classList.remove('video-hidden');
                    videoFeed.classList.add('video-visible');
                    placeholder.classList.remove('video-visible');
                    placeholder.classList.add('video-hidden');
        }

        function stopVideoFeed() {
            const videoFeed = document.getElementById('videoFeed');
            const placeholder = document.getElementById('videoPlaceholder');
            
            videoFeed.src = '';
            videoFeed.classList.add('video-hidden');
            placeholder.classList.remove('video-hidden');
            placeholder.classList.add('video-visible');
        }

        function startStatusUpdates() {
            updateInterval = setInterval(updateStatus, 1000);
        }

        function stopStatusUpdates() {
                    if (updateInterval) {
                        clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/get_session_data');
                const data = await response.json();
                
                document.getElementById('currentCount').textContent = `è®¡æ•°: ${data.current_count || 0}`;
                
                // Update center line slider if YOLO counter is running
                if (isRunning && selectedCounterType === 'yolo') {
                    await updateCenterLineSliderFromCounter();
                }
            } catch (error) {
                console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ä¸­å¿ƒçº¿æ»‘å—å€¼ä»¥åŒ¹é…è®¡æ•°å™¨çš„å®é™…å€¼
        async function updateCenterLineSliderFromCounter() {
            try {
                const response = await fetch('/get_center_line_position');
                const data = await response.json();
                
                if (data.success && data.calibrated) {
                    const centerLineSlider = document.getElementById('centerLineSlider');
                    const centerLineValue = document.getElementById('centerLineSliderValue');
                    
                    if (centerLineSlider && centerLineValue) {
                        // Only set slider value if it's not already initialized or if the value has changed significantly
                        const currentSliderValue = parseInt(centerLineSlider.value);
                        const actualPosition = Math.round(data.position);
                        
                        if (!centerLineSlider.dataset.initialized || Math.abs(currentSliderValue - actualPosition) > 50) {
                            // Ensure the actual position is within slider range
                            const clampedPosition = Math.max(50, Math.min(2000, actualPosition));
                            centerLineSlider.value = clampedPosition;
                            centerLineValue.textContent = clampedPosition;
                            centerLineSlider.dataset.initialized = 'true';
                            console.log(`ğŸšï¸ æ»‘å—åˆå§‹åŒ–ä¸ºä¸­å¿ƒçº¿ä½ç½®: ${clampedPosition} (å®é™…: ${actualPosition})`);
                            
                            // Warn if position is outside slider range
                            if (actualPosition > 2000) {
                                console.warn(`âš ï¸ ä¸­å¿ƒçº¿ä½ç½® ${actualPosition} è¶…å‡ºæ»‘å—æœ€å¤§å€¼ 2000ï¼Œè¯·ä½¿ç”¨æŒ‰é’®è°ƒæ•´`);
                            } else if (actualPosition < 50) {
                                console.warn(`âš ï¸ ä¸­å¿ƒçº¿ä½ç½® ${actualPosition} ä½äºæ»‘å—æœ€å°å€¼ 50ï¼Œè¯·ä½¿ç”¨æŒ‰é’®è°ƒæ•´`);
                            }
                        }
                    }
                }
            } catch (error) {
                // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½
            }
        }

        // è°ƒæ•´å‡½æ•° - ç®€åŒ–ç‰ˆæœ¬
        async function adjustCenterLine(adjustment) {
            await makeAdjustment('/adjust_center_line', { adjustment });
        }

        async function adjustCenterLineAbsolute(position) {
            await makeAdjustment('/adjust_center_line_absolute', { position });
        }

        async function adjustSensitivityAbsolute(value) {
            await makeAdjustment('/adjust_sensitivity_absolute', { value });
        }

        async function resetCalibration() {
            const result = await makeAdjustment('/reset_calibration', {});
            
            // Reset slider initialization flag so it can be re-initialized after calibration
            const centerLineSlider = document.getElementById('centerLineSlider');
            if (centerLineSlider) {
                centerLineSlider.dataset.initialized = 'false';
                // Reset slider to middle of range for better coverage
                centerLineSlider.value = 1000;  // Middle of 50-2000 range
                document.getElementById('centerLineSliderValue').textContent = '1000';
            }
            
            // Reset sensitivity slider to default
            const sensitivitySlider = document.getElementById('sensitivitySlider');
            if (sensitivitySlider) {
                sensitivitySlider.value = 1.0;
                document.getElementById('sensitivitySliderValue').textContent = '1.0';
            }
            
            // Reset count display
            document.getElementById('currentCount').textContent = 'è®¡æ•°: 0';
            
            return result;
        }

        async function makeAdjustment(endpoint, data) {
            if (!isRunning) {
                showMessage('è¯·å…ˆå¯åŠ¨è®¡æ•°å™¨', 'error');
                return;
            }

            if (selectedCounterType !== 'yolo' && endpoint.includes('center_line')) {
                showMessage('åªæœ‰YOLOè®¡æ•°å™¨æ”¯æŒä¸­å¿ƒçº¿è°ƒæ•´', 'error');
                return;
            }

            try {
                console.log(`å‘é€è°ƒæ•´è¯·æ±‚: ${endpoint}`, data);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('è°ƒæ•´å“åº”:', result);
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // æ›´æ–°æ»‘å—æ˜¾ç¤º
                    if (result.new_center_line && document.getElementById('centerLineSlider')) {
                        document.getElementById('centerLineSlider').value = result.new_center_line;
                        document.getElementById('centerLineSliderValue').textContent = result.new_center_line;
                    }
                } else {
                    showMessage(result.error || 'è°ƒæ•´å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è°ƒæ•´å¤±è´¥:', error);
                showMessage(`è°ƒæ•´å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é”®ç›˜æ§åˆ¶
        function handleKeyboard(event) {
            if (!isRunning || selectedCounterType !== 'yolo') return;

            const keyActions = {
                'KeyW': () => adjustCenterLine(-0.05),
                'ArrowUp': () => adjustCenterLine(-0.05),
                'KeyS': () => adjustCenterLine(0.05),
                'ArrowDown': () => adjustCenterLine(0.05),
                'Equal': () => adjustSensitivity('decrease'),
                'Minus': () => adjustSensitivity('increase'),
                'Digit0': () => resetCalibration()
            };

            if (keyActions[event.code]) {
                event.preventDefault();
                keyActions[event.code]();
                console.log(`é”®ç›˜å¿«æ·é”®: ${event.code}`);
            }
        }
        
        async function adjustSensitivity(direction) {
            await makeAdjustment('/adjust_sensitivity', { direction });
        }

        // å®æ—¶å‚æ•°æ›´æ–°
        async function updateParameterRealtime(paramName, paramValue) {
            try {
                console.log(`å®æ—¶æ›´æ–°å‚æ•°: ${paramName} = ${paramValue}`);
                const response = await fetch('/update_parameter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parameter: paramName,
                        value: paramValue
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`å‚æ•°æ›´æ–°æˆåŠŸ: ${result.message}`);
                    // å¯é€‰ï¼šæ˜¾ç¤ºç®€çŸ­çš„æˆåŠŸæ¶ˆæ¯
                    // showMessage(result.message, 'success');
                } else {
                    console.error('å‚æ•°æ›´æ–°å¤±è´¥:', result.error);
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('å‚æ•°æ›´æ–°è¯·æ±‚å¤±è´¥:', error);
                showMessage(`å‚æ•°æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ–‡ä»¶ä¸Šä¼ 
        async function uploadVideo() {
            const fileInput = document.getElementById('videoFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;

            const formData = new FormData();
            formData.append('video_file', file);

            try {
                showMessage('ä¸Šä¼ ä¸­...', 'success');
                const response = await fetch('/upload_video', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // è‡ªåŠ¨åˆ‡æ¢åˆ°å·²ä¸Šä¼ è§†é¢‘å¹¶åˆ·æ–°åˆ—è¡¨
                    document.getElementById('videoSource').value = 'uploaded';
                    document.getElementById('uploadVideoGroup').classList.add('hidden');
                    document.getElementById('uploadedVideoGroup').classList.remove('hidden');
                    await loadUploadedVideos();
                    // è‡ªåŠ¨é€‰æ‹©åˆšä¸Šä¼ çš„è§†é¢‘
                    document.getElementById('uploadedVideoSelect').value = result.filepath;
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½å·²ä¸Šä¼ è§†é¢‘åˆ—è¡¨
        async function loadUploadedVideos() {
            try {
                const response = await fetch('/list_uploaded_videos');
                const data = await response.json();
                
                const select = document.getElementById('uploadedVideoSelect');
                select.innerHTML = '<option value="">-- é€‰æ‹©å·²ä¸Šä¼ è§†é¢‘ --</option>';
                
                if (data.videos && data.videos.length > 0) {
                    data.videos.forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.filepath;
                        option.textContent = `${video.filename} (${video.size_mb}MB)`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'æ²¡æœ‰å·²ä¸Šä¼ çš„è§†é¢‘';
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥', 'error');
            }
        }
        
        // å½•åˆ¶åŠŸèƒ½
        async function startRecording() {
                if (!isRunning) {
                showMessage('è¯·å…ˆå¯åŠ¨è®¡æ•°å™¨', 'error');
                    return;
                }
                
            try {
                const response = await fetch('/start_recording', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    isRecording = true;
                    updateButtonStates();
                    updateRecordingStatus('ğŸ”´ å½•åˆ¶ä¸­...', 'recording');
                    showMessage('å½•åˆ¶å·²å¼€å§‹', 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`å½•åˆ¶å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function stopRecording() {
            try {
                const response = await fetch('/stop_recording', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    isRecording = false;
                    updateButtonStates();
                    
                    // Show detailed recording information
                    const fileInfo = result.file_size_mb > 0 
                        ? `âœ… å½•åˆ¶å®Œæˆ: ${result.filename} (${result.file_size_mb}MB, ${result.duration}s)`
                        : `âš ï¸ å½•åˆ¶å®Œæˆä½†æ–‡ä»¶ä¸ºç©º: ${result.filename} (0MB)`;
                    
                    updateRecordingStatus(fileInfo, result.file_size_mb > 0 ? 'completed' : 'warning');
                    
                    // Only enable download if file has content
                    document.getElementById('downloadRecordingBtn').disabled = result.file_size_mb <= 0;
                    
                    const message = result.file_size_mb > 0 
                        ? `å½•åˆ¶å·²åœæ­¢: ${result.filename} (${result.file_size_mb}MB)`
                        : `å½•åˆ¶åœæ­¢ï¼Œä½†æ–‡ä»¶ä¸ºç©ºã€‚è¯·æ£€æŸ¥å½•åˆ¶è®¾ç½®å’Œç¼–è§£ç å™¨æ”¯æŒã€‚`;
                    
                    showMessage(message, result.file_size_mb > 0 ? 'success' : 'error');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage(`å½•åˆ¶åœæ­¢å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function downloadRecording() {
            try {
                const response = await fetch('/download_latest_recording');
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const filename = response.headers.get('content-disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'recording.mp4';
                    
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showMessage('å½•åˆ¶è§†é¢‘ä¸‹è½½æˆåŠŸ!', 'success');
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'ä¸‹è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function updateRecordingStatus(message, type) {
            const statusDiv = document.getElementById('recordingStatus');
            statusDiv.textContent = message;
            
            if (type === 'recording') {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
            } else if (type === 'completed') {
                statusDiv.style.background = '#e8f5e8';
                statusDiv.style.color = '#2e7d32';
            } else if (type === 'warning') {
                statusDiv.style.background = '#fff3e0';
                statusDiv.style.color = '#ef6c00';
            } else {
                statusDiv.style.background = '#f0f8ff';
                statusDiv.style.color = '#1976d2';
            }
        }

        // æ¶ˆæ¯æ˜¾ç¤º
        function showMessage(message, type) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.textContent = message;
            messageDiv.className = `status-message status-${type}`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html> 